#!/usr/bin/env -S bash -l

# NOTE: Bash is called above as a login shell using the -l flag to force
# /etc/profile and ~/.profile to be read, since this script may get
# called by GUI processes where the full shell environment (including
# Homebrew's path) hasn't been initialized

set -e

if [[ "$FLAVOR" == "macos" ]]; then
	exec open -a Obsidian.app
elif [[ "$FLAVOR" == "termux" ]]; then
	exec proot-distro login debian \
	                --no-arch-warning \
	                --isolated \
	                --shared-tmp \
	                --env  DISPLAY=${DISPLAY:-:0} \
	                --env  PULSE_SERVER=${PULSE_SERVER:-tcp:127.0.0.1} \
	                --env  GALLIUM_DRIVER=virpipe \
	                --env  MESA_GL_VERSION_OVERRIDE=4.0 \
	                --bind $HOME/storage/shared/Documents/Obsidian:/home/necopinus/notes \
	                --bind $HOME/storage/downloads:/home/necopinus/downloads \
	                --user necopinus \
	                --     /home/necopinus/local/lib/obsidian/obsidian "$@"
elif [[ -x "$HOME/local/lib/obsidian/obsidian" ]]; then
	exec $HOME/local/lib/obsidian/obsidian "$@"
else
	export OLD_PATH="$PATH"
	export PATH="$(echo ":$PATH:" | sed "s#:$HOME/bin:#:#g;s#:$HOME/local/bin:#:#g;s#:$HOME/.local/bin:#:#g;s/^://;s/:\$//")"

	OBSIDIAN_EXE="$(which obsidian 2> /dev/null)"

	export PATH="$OLD_PATH"
	unset OLD_PATH

	if [[ -n "$OBSIDIAN_EXE" ]]; then
		exec "$OBSIDIAN_EXE" "$@"
	else
		echo "Could not locate Obsidian!"
		exit 1
	fi
fi

#!/usr/bin/env bash

set -e

source ${XDG_CONFIG_HOME:-$HOME/.config}/user-dirs.dirs

(
	cd $HOME
	tar -cJv --exclude=.DS_Store \
	         --exclude=.localized \
	         --exclude="S.*" \
	         --exclude="*.pyc" \
	         --exclude="*.swp" \
	         --exclude="*~" \
	         --exclude=".#*" \
	    -f "$XDG_DOWNLOAD_DIR/backup.tar.xz" -T - <<- EOF
			$(git --git-dir=$HOME/.dotfiles --work-tree=$HOME ls-tree -r HEAD --name-only)
			$(test -d .dotfiles && echo ".dotfiles")
			$(test -d .gnupg && echo ".gnupg")
			$(test -d .ssh && echo ".ssh")
			$(test -d .dvdcss && echo ".dvdcss")
			$(test -d "$XDG_CONFIG_HOME/aacs" && echo "$XDG_CONFIG_HOME/aacs" | sed "s#$HOME/##")
			$(test -f "$XDG_CONFIG_HOME/shodan/api_key" && echo "$XDG_CONFIG_HOME/shodan/api_key" | sed "s#$HOME/##")
			$(test -f "$XDG_CONFIG_HOME/api-keys.env.sh" && echo "$XDG_CONFIG_HOME/api-keys.env.sh" | sed "s#$HOME/##")
			$(test -f "$XDG_CONFIG_HOME/qobuz-dl/config.ini" && echo "$XDG_CONFIG_HOME/qobuz-dl/config.ini" | sed "s#$HOME/##")
			$(test -d "data/calibre" && echo "data/calibre")
			$(test -d "Library/Preferences/calibre" && echo "Library/Preferences/calibre")
			$(test -d "$XDG_CONFIG_HOME/calibre" && echo "$XDG_CONFIG_HOME/calibre" | sed "s#$HOME/##")
			$(test -f "$XDG_CONFIG_HOME/git/config" && echo "$XDG_CONFIG_HOME/git/config" | sed "s#$HOME/##")
			$(test -f .gitconfig && echo ".gitconfig")
			EOF
)

#!/usr/bin/env -S bash -l

# NOTE: Bash is called above as a login shell using the -l flag to force
# /etc/profile and ~/.profile to be read, since this script may get
# called by GUI processes where the full shell environment (including
# Homebrew's path) hasn't been initialized

# TODO: This is not very well tested...

set -e

# Convenience function to switch to the tmux window/pane running nvim
#
function switch_to_nvim_tmux_pane {
	NVIM_TMUX_LOCATION="$(
		tmux list-panes -a -F "#{pane_current_command}%%%#{pane_title}%%%#{window_id}%%%#{pane_id}%%%#{session_attached}" \
			| sed 's/%%%/\t/g' | grep -E "(^|$(echo -ne '\t'))nvim" || true
	)"

	if [[ -n "$NVIM_TMUX_LOCATION" ]]; then
		tmux select-window -t "$(echo "$NVIM_TMUX_LOCATION" | cut -d "$(echo -ne '\t')" -f 3)"
		tmux select-pane -t "$(echo "$NVIM_TMUX_LOCATION" | cut -d "$(echo -ne '\t')" -f 4)"

		if [[ $(echo "$NVIM_TMUX_LOCATION" | cut -d "$(echo -ne '\t')" -f 5) -eq 0 ]]; then
			echo "NeoViM is running in a detached tmux session"
		fi
	fi
}

# Actual flow control is not that exciting
#
if [[ -n "$NVIM" ]]; then
	nvr -s "$@"
else
	NVIM_SERVER_LIST="$(nvr --serverlist 2> /dev/null)"

	if [[ -n "$NVIM_SERVER_LIST" ]]; then
		if [[ $(echo "$NVIM_SERVER_LIST" | wc -l) -eq 1 ]]; then
			if [[ $(pgrep tmux | wc -l) -gt 0 ]]; then
				switch_to_nvim_tmux_pane
			fi
		fi

		NVIM_SERVER="$(echo "$NVIM_SERVER_LIST" | head -1)"

		echo "Opening file in NeoViM server $NVIM_SERVER"
		nvr -s --servername "$NVIM_SERVER" "$@"
	else
		if [[ -n "$DISPLAY" ]] || [[ -n "$WAYLAND_DISPLAY" ]] || [[ "$OS" == "macos" ]]; then
			TMUX_SESSIONS="$(tmux list-sessions -F "#{session_name} #{session_attached}" 2> /dev/null || true)"

			if [[ $(echo "$TMUX_SESSIONS" | wc -l) -gt 0 ]]; then
				TMUX_DEFAULT_SESSION="$(hostname | sed 's/\./_/g')"

				if [[ $(echo "$TMUX_SESSIONS" | grep "^${TMUX_DEFAULT_SESSION} " | cut -d " " -f 2) -gt 0 ]]; then
					tmux new-window -t ${TMUX_DEFAULT_SESSION}: nvr -s "$@"
					switch_to_nvim_tmux_pane
				elif [[ $(echo "$TMUX_SESSIONS" | grep -vc ' 0$') -gt 0 ]]; then
					tmux new-window -t $(echo "$TMUX_SESSIONS" | grep -v ' 0$' | head -1 | cut -d " " -f 1): nvr -s "$@"
					switch_to_nvim_tmux_pane
				elif [[ $(echo "$TMUX_SESSIONS" | grep -c "^${TMUX_DEFAULT_SESSION} ") -eq 1 ]]; then
					tmux new-window -t ${TMUX_DEFAULT_SESSION}: nvr -s "$@"
					switch_to_nvim_tmux_pane
				else
					tmux new-window -t $(echo "$TMUX_SESSIONS" | head -1 | cut -d " " -f 1): nvr -s "$@"
					switch_to_nvim_tmux_pane
				fi
			else
				if [[ ! -f "$HOME/_notmux" ]] && [[ ! -f "$HOME/_notmux.txt" ]]; then
					kitty tmux new-session -A -s $(hostname | sed 's/\./_/g') nvr -s "$@" &
					disown
				else
					kitty nvr -s "$@" &
					disown
				fi
			fi
		else
			nvr -s "$@"
		fi
	fi
fi

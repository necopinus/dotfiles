#!/usr/bin/env -S bash -l

# NOTE: Bash is called above as a login shell using the -l flag to force
# /etc/profile and ~/.profile to be read in order to ensure that the
# environment is fully set up

export DISPLAY=:0

# Clean up environment
#
unset NVIM_PLAIN_DARK_THEME TERM TERM_PROGRAM TMUX TMUX_PANE

if [[ -n "$PROFILE_PATH" ]]; then
	export PATH="$PROFILE_PATH:$PATH"
	unset PROFILE_PATH
fi

NEW_PATH=""
for PATH_ELEMENT in $(echo "$PATH" | tr ':' ' '); do
	if [[ ":$NEW_PATH:" != *":$PATH_ELEMENT:"* ]]; then
		if [[ -d "$PATH_ELEMENT" ]]; then
			NEW_PATH="$NEW_PATH:$PATH_ELEMENT"
		fi
	fi
done
export PATH="${NEW_PATH:1}"
unset NEW_PATH

if [[ -d "$HOME/local/lib/kitty.app/share/man" ]]; then
	export MANPATH=":$HOME/local/lib/kitty.app/share/man"
elif [[ -d "/Applications/kitty.app/Contents/Resources/man" ]]; then
	export MANPATH=":/Applications/kitty.app/Contents/Resources/man"
else
	unset MANPATH
fi

# Actual launch process
#
dbus-launch --exit-with-session vncserver $DISPLAY -localhost -SecurityTypes None -fg -AlwaysShared -- xfce

# Try (probably futile) to guard against filesystem corruption in the
# Android Debian VM
#
sync

unset DISPLAY

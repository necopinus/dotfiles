#!/usr/bin/env bash

set -e

DEBIAN_DIR="$PREFIX/var/lib/proot-distro/installed-rootfs/debian"

# Timezone maintenance
#
ANDROID_TZ=$(getprop persist.sys.timezone)

if [[ -f "$DEBIAN_DIR/usr/share/zoneinfo/$ANDROID_TZ" ]]; then
	rm $DEBIAN_DIR/etc/localtime || true

	cp $(realpath $DEBIAN_DIR/usr/share/zoneinfo/$ANDROID_TZ) \
	              $DEBIAN_DIR/etc/localtime
fi

# Pass along relevant environment variables
#
ENV_ARGS=()
ENV_ARGS+=(--env LANG=en_US.UTF-8)
if [[ "$TERM" =~ ^tmux ]] || [[ "$TERM" =~ ^screen ]]; then
	ENV_ARGS+=(--env TERM=$TERM)
	export TERM=$TERM
else
	ENV_ARGS+=(--env TERM=xterm-256color)
	export TERM=xterm-256color
fi
if [[ -n "$DISPLAY" ]]; then
	ENV_ARGS+=(--env DISPLAY=$DISPLAY)
	ENV_ARGS+=(--shared-tmp)
fi
if [[ -n "$PULSE_SERVER" ]]; then
	ENV_ARGS+=(--env PULSE_SERVER=$PULSE_SERVER)
fi

# Proot backup convenience function
#
function backup_debian_proot {
	if [[ -d "$DEBIAN_DIR" ]]; then
		if [[ -d "$HOME/storage/downloads" ]]; then
			PROOT_BACKUP_DIR="$HOME/storage/downloads"
		else
			PROOT_BACKUP_DIR="$HOME"
		fi
		proot-distro backup debian --output "$PROOT_BACKUP_DIR"/debian.tar
		xz -v "$PROOT_BACKUP_DIR"/debian.tar
	else
		echo "Debian proot does not appear to be installed"
		exit 1
	fi
}

# Flow control
#
if [[ $# -eq 0 ]]; then
	exec proot-distro login debian \
	                --no-arch-warning \
	                --isolated "${ENV_ARGS[@]}" \
	                --env SHELL=/usr/bin/bash \
	                --env TMUX_TMPDIR=/home/necopinus/.local/run \
	                --bind $HOME/storage/shared/Documents/Obsidian:/home/necopinus/notes \
	                --bind $HOME/storage/downloads:/home/necopinus/downloads \
	                --bind $HOME/config/calibre:/home/necopinus/.config/calibre \
	                --bind $HOME/data/calibre:/home/necopinus/data/calibre \
	                --bind $HOME/src:/home/necopinus/src \
	                --user necopinus \
	                -- /usr/bin/bash -li
elif [[ $# -eq 1 ]] && [[ "$1" =~ ^--tmux$ ]]; then
	exec proot-distro login debian \
	                --no-arch-warning \
	                --isolated "${ENV_ARGS[@]}" \
	                --env SHELL=/usr/bin/bash \
	                --env TMUX_TMPDIR=/home/necopinus/.local/run \
	                --bind $HOME/storage/shared/Documents/Obsidian:/home/necopinus/notes \
	                --bind $HOME/storage/downloads:/home/necopinus/downloads \
	                --bind $HOME/config/calibre:/home/necopinus/.config/calibre \
	                --bind $HOME/data/calibre:/home/necopinus/data/calibre \
	                --bind $HOME/src:/home/necopinus/src \
	                --user necopinus \
	                -- /usr/bin/tmux
elif [[ $# -eq 1 ]] && [[ "$1" =~ ^--root$ ]]; then
	exec proot-distro login debian \
	                --no-arch-warning \
	                --isolated "${ENV_ARGS[@]}"
elif [[ $# -eq 1 ]] && [[ "$1" =~ ^--install$ ]]; then
	if [[ ! -d "$DEBIAN_DIR" ]]; then
		proot-distro install debian

		sed -i 's/ main contrib$/ main contrib non-free non-free-firmware/' \
		       $DEBIAN_DIR/etc/apt/sources.list


		mkdir -p $DEBIAN_DIR/usr/share/keyrings
		curl -fsSLo \
		     $DEBIAN_DIR/usr/share/keyrings/brave-browser-archive-keyring.gpg \
		     https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
		tee $DEBIAN_DIR/etc/apt/sources.list.d/brave-browser.sources > /dev/null <<- EOF
			Types: deb
			URIs: https://brave-browser-apt-release.s3.brave.com
			Suites: stable
			Components: main
			Architectures: amd64 arm64
			Signed-By: /usr/share/keyrings/brave-browser-archive-keyring.gpg
			EOF

		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt update --fix-missing
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt full-upgrade --fix-broken
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt install \
		                                 brave-browser \
		                                 calibre \
		                                 dialog \
		                                 fonts-noto \
		                                 libasound2 \
		                                 libatspi2.0-0 \
		                                 libgtk-3-0 \
		                                 libnotify4 \
		                                 libnss3 \
		                                 libsecret-1-0 \
		                                 libuuid1 \
		                                 libxss1 \
		                                 libxtst6 \
		                                 man-db \
		                                 nano \
		                                 npm \
		                                 sudo \
		                                 tmux \
		                                 xdg-utils \
		                                 xsel
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt autoremove --purge --autoremove
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt clean

		proot-distro login debian --no-arch-warning --isolated \
		                          -- useradd --create-home \
		                                     --shell /usr/bin/bash \
		                                     --groups adm,audio,cdrom,dialout,dip,floppy,plugdev,sudo,staff,users,video \
		                                       necopinus

		mkdir -p $DEBIAN_DIR/etc
		rm -f $DEBIAN_DIR/etc/localtime
		if [[ -f "$DEBIAN_DIR/usr/share/zoneinfo/$ANDROID_TZ" ]]; then
			cp $(realpath $DEBIAN_DIR/usr/share/zoneinfo/$ANDROID_TZ) \
			              $DEBIAN_DIR/etc/localtime
		else
			cp $(realpath $DEBIAN_DIR/usr/share/zoneinfo/UTC) \
			              $DEBIAN_DIR/etc/localtime
		fi

		mkdir -p $DEBIAN_DIR/etc/sudoers.d
		cp $HOME/local/lib/linux/termux/common/proot/debian/etc/sudoers.d/necopinus \
		   $DEBIAN_DIR/etc/sudoers.d/necopinus

		mkdir -p $DEBIAN_DIR/home/necopinus
		cp $HOME/local/lib/linux/termux/common/proot/debian/home/necopinus/.bash_aliases \
		   $DEBIAN_DIR/home/necopinus/.bash_aliases
		cp $HOME/local/lib/linux/termux/common/proot/debian/home/necopinus/.inputrc \
		   $DEBIAN_DIR/home/necopinus/.inputrc

		mkdir -p $DEBIAN_DIR/home/necopinus/.config
		cp $HOME/local/lib/linux/termux/common/proot/debian/home/necopinus/.config/user-dirs.dirs \
		   $DEBIAN_DIR/home/necopinus/.config/user-dirs.dirs

		mkdir -p $DEBIAN_DIR/home/necopinus/.config/nano
		cp $HOME/local/lib/linux/termux/common/proot/debian/home/necopinus/.config/nano/nanorc \
		   $DEBIAN_DIR/home/necopinus/.config/nano/nanorc

		mkdir -p $DEBIAN_DIR/home/necopinus/.config/tmux
		cp $HOME/local/lib/linux/termux/common/proot/debian/home/necopinus/.config/tmux/tmux.conf \
		   $DEBIAN_DIR/home/necopinus/.config/tmux/tmux.conf

		mkdir -p $DEBIAN_DIR/home/necopinus/.config/calibre
		mkdir -p $DEBIAN_DIR/home/necopinus/.local/run

		mkdir -p $DEBIAN_DIR/home/necopinus/data/calibre
		mkdir -p $DEBIAN_DIR/home/necopinus/data/desktop
		mkdir -p $DEBIAN_DIR/home/necopinus/data/music
		mkdir -p $DEBIAN_DIR/home/necopinus/data/pictures
		mkdir -p $DEBIAN_DIR/home/necopinus/data/templates
		mkdir -p $DEBIAN_DIR/home/necopinus/data/videos
		mkdir -p $DEBIAN_DIR/home/necopinus/downloads
		mkdir -p $DEBIAN_DIR/home/necopinus/notes
		mkdir -p $DEBIAN_DIR/home/necopinus/public
		mkdir -p $DEBIAN_DIR/home/necopinus/src

		proot-distro clear-cache

		# Fix bad permissions on /usr/bin/sudo
		#
		proot-distro login debian --no-arch-warning --isolated \
		                          -- chmod u+s /usr/bin/sudo
	else
		echo "Debian proot appears to be already installed"
		# Do not exit with failure here, as this will bork the setup script
	fi
elif [[ $# -eq 1 ]] && [[ "$1" =~ ^--update$ ]]; then	
	if [[ -d "$DEBIAN_DIR" ]]; then
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt update
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt full-upgrade
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt autoremove --purge --autoremove
		proot-distro login debian --no-arch-warning --isolated \
		                          -- apt clean

		# Fix bad permissions on /usr/bin/sudo
		#
		proot-distro login debian --no-arch-warning --isolated \
		                          -- chmod u+s /usr/bin/sudo
	else
		echo "Debian proot does not appear to be installed"
		exit 1
	fi
elif [[ $# -eq 1 ]] && [[ "$1" =~ ^--backup$ ]]; then
	backup_debian_proot
elif [[ $# -eq 1 ]] && [[ "$1" =~ ^--archive$ ]]; then
	backup_debian_proot
	
	if [[ -d "$DEBIAN_DIR" ]]; then
		proot-distro remove debian
	else
		echo "Debian proot does not appear to be installed"
		exit 1
	fi
else
	exec proot-distro login debian \
	                --no-arch-warning \
	                --work-dir "$(pwd)" "${ENV_ARGS[@]}" \
	                --env SHELL=/usr/bin/bash \
	                --env TMUX_TMPDIR=/home/necopinus/.local/run \
	                --bind $HOME/storage/shared/Documents/Obsidian:/home/necopinus/notes \
	                --bind $HOME/storage/downloads:/home/necopinus/downloads \
	                --bind $HOME/src:/home/necopinus/src \
	                --user necopinus \
	                -- "$@"
fi

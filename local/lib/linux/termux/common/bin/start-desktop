#!/usr/bin/env bash

# Environment set up
#
source $HOME/.profile

# Convenience function to make sure that our X session is *really* dead
#
function clean_up_x_display {
	TERMUX_ANDROID_USER=$(whoami)

	pkill --full com.termux.x11
	pkill -9 dbus
	pkill --full pulseaudio

	rm --recursive --force $PREFIX/../home/.config/pulse
	rm --recursive --force $PREFIX/var/run/dbus/pid
	rm --recursive --force $PREFIX/tmp/dbus-*
	rm --recursive --force $PREFIX/tmp/*-${TERMUX_ANDROID_USER}
	rm --recursive --force $PREFIX/tmp/*-${TERMUX_ANDROID_USER}.*
	rm --recursive --force $PREFIX/tmp/*_${TERMUX_ANDROID_USER}
	rm --recursive --force $PREFIX/tmp/*-necopinus
	rm --recursive --force $PREFIX/tmp/*-necopinus.*
	rm --recursive --force $PREFIX/tmp/*_necopinus
	rm --recursive --force $PREFIX/tmp/*-kali
	rm --recursive --force $PREFIX/tmp/*-kali.*
	rm --recursive --force $PREFIX/tmp/*_kali
	rm --recursive --force $PREFIX/tmp/proot-*
	rm --recursive --force $PREFIX/tmp/pulse-*
	rm --recursive --force $PREFIX/tmp/.ICE-unix
	rm --recursive --force $PREFIX/tmp/.X0-lock
	rm --recursive --force $PREFIX/tmp/.X11-unix
}

# Actual launch process
#
clean_up_x_session

dbus-daemon --system --fork --address=unix:path=$PREFIX/var/run/dbus/system_bus_socket

if [[ "$(getprop ro.product.manufacturer | tr '[:upper:]' '[:lower:]')" == "samsung" ]]; then
	env LD_PRELOAD=/system/lib64/libskcodec.so \
	pulseaudio --start \
               --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" \
               --exit-idle-time=-1
else
	pulseaudio --start \
	           --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" \
	           --exit-idle-time=-1
fi
export PULSE_SERVER=tcp:127.0.0.1

export DISPLAY=:0

termux-x11 $DISPLAY &

am start-activity -W com.termux.x11/com.termux.x11.MainActivity

$HOME/.xinitrc

clean_up_x_session
